<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Eldorito Server Browser </title>

<link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Raleway" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Quicksand" />

<link rel='stylesheet' href='./css/epicfullscreen.css' type='text/css' media='all' />
<link rel='stylesheet' href='./css/style.css' type='text/css' media='all' />
<link rel='stylesheet' href='./css/skin.css' type='text/css' media='all' />

<script type='text/javascript' src='./js/jquery-1.11.0.min.js'></script>
<script type='text/javascript' src='./js/jquery.ui.core.min.js'></script>
<script type='text/javascript' src='./js/jquery.epicfullscreen.js'></script>
<script type='text/javascript' src='./js/jquery.fancybox-1.3.4.pack.js'></script>
<script type='text/javascript' src='./js/settings.js'></script>
<script type='text/javascript' src='./js/common.js'></script>

<script src="./src/ping.js" type="text/javascript"></script>

<div id="fullscreen-1" class="epic-fullscreen" data-image="images/background/background.jpg"></div>
 
</head>
 
<body class="home page">
 
<div id="header-wrapper">
<div id="header-inner">
<header></header>
<div style="clear:both;"></div>
</div>

<div id="content-wrapper">
        <section class="homepage">
                <div id="section-title">
                        <div id="teaser" class="teaser-no-title">
                                <div id="browser-title"><img src="eldorito.png" alt="" height="50" width="50"> ELDORITO SERVER BROWSER</div>
                                <header>
		</header>
</nav>
        <center><button id="refresh" style="background-color: rgba(255, 255, 255, 0.1);color: rgba(255,255,255,0.95);">Refresh</button></center>
        <table id="serverlist" style="width:100%">
  <tr>
    <td style="padding-left:10px;background-color: rgba(255, 255, 255, 0.1);color: rgba(255,255,255,0.95);width:240px"><b><center>Game</center></b></td>
    <td style="padding-left:10px;background-color: rgba(255, 255, 255, 0.1);color: rgba(255,255,255,0.95);"><b>Server Name | Host Player</b></td>
    <td style="padding-left:10px;background-color: rgba(255, 255, 255, 0.1);color: rgba(255,255,255,0.95);"><b><center>Status</center></b></td>
    <td style="padding-left:10px;background-color: rgba(255, 255, 255, 0.1);color: rgba(255,255,255,0.95);"><b><center>Players</center></b></td>
  </tr>
  <td>
</table><br>
 
<script type="text/javascript">
$(document).ready(function()
{
    // queryServer("192.99.124.162/list");
   // addServer("127.0.0.1:11775", "Test server", "emoose", "Guardian", "guardian", "Team Slayer", "1", "16");
});

    $("#serverlist").find("tr:gt(0)").remove();

    $.getJSON( "http://192.99.124.162/list", function( data ) {
        if(data.result.code != 0)
        {
            alert("Error received from master: " + data.result.msg);
            return;
        }
        console.log(data);
        for(var i = 0; i < data.result.servers.length; i++)
        {
            var serverIP = data.result.servers[i];
            queryServer(serverIP);
        }
    });



$("#refresh").click(function()
{
    $("#serverlist").find("tr:gt(0)").remove();

    $.getJSON( "http://192.99.124.162/list", function( data ) {
        if(data.result.code != 0)
        {
            alert("Error received from master: " + data.result.msg);
            return;
        }
        console.log(data);
        for(var i = 0; i < data.result.servers.length; i++)
        {
            var serverIP = data.result.servers[i];
            queryServer(serverIP);
        }
    });
});
    
function queryServer(serverIP)
{
    console.log(serverIP);
    var startTime = Date.now();
    $.getJSON("http://" + serverIP, function(serverInfo) {
        var timeTaken = Date.now() - startTime;
        console.log(timeTaken);
        if(serverInfo.name === undefined) return;
        var isPassworded = serverInfo.passworded !== undefined;
//if no serverInfo.map, they jumped into an active game without unannouncing their server, causing a duplicate unjoinable game
        if(serverInfo.map == "") return;
        addServer(serverIP, isPassworded, serverInfo.name, serverInfo.hostPlayer, serverInfo.map, serverInfo.mapFile, serverInfo.variant, serverInfo.status, serverInfo.numPlayers, serverInfo.maxPlayers, timeTaken);
        console.log(serverInfo);
    });
}

function promptPassword(serverIP)
{
    var password = prompt("The server at " + serverIP + " is passworded, enter the password to join", "");
    if(password != null)
    {
        window.open("dorito:" + serverIP + "/" + password);
    }
}

function addServer(ip, isPassworded, name, host, map, mapfile, gamemode, status, numplayers, maxplayers, ping)
{
//because people can't be trusted with html tags, filter them out
	name = sanitizeString(name);
	name = name.substring(0,50);
	host = sanitizeString(host);
	host = host.substring(0,50);

    var servName = "<td>" + name + "</br>" + "<b>Host</b> - " + host + "</br>" + "<b> IP </b> - " + ip + " - <a href=\"#\" onClick=\"callbacks.connect('" + ip + "');\">" + "<b><font color=red>Join</font></b></a>"   + "</br>" + "<b>Variant</b> - " + map + "</br>" + "<b>GameType</b> - " + gamemode + "</br>" + "</td>";
    if(isPassworded)
        servName = "<td><a href=\"#\" onclick=\"promptPassword('" + ip + "');\">[PASSWORDED] " + name + " (" + host + ")</a></td>";

    var servMapImage = "<td>" + "<img src=" + "images/maps/" + mapfile + ".png width=250px height=350px ></br>" + "</td>";
    var servStatus = "<td>" + status + "</td>";
    var servPlayers = "<td>" + numplayers + "/" + maxplayers + "</td>";

    $('#serverlist tr:last').after("<tr>" + servMapImage + servName + servStatus + servPlayers + "</tr>");

}

 
</script>
            </div>
        </div>
    </section> 
</div>
</body>
</html>
